---
title: "Death by Heart Failure"
output: html_document
---

```{r setup, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE)
library(tidyverse)
library(caret)
library(RColorBrewer)
library(ROCR)
# install.packages("MLmetrics")
library(MLmetrics)
# install.packages("e1071")
library(e1071)
```

### Part 1 


#### Implementation

This data set involves different variables that are considered to affect the heart and sometimes lead to even heart failure. We want to apply KNN to this dataset to determine if we can create a model that predicts whether the patient will have a heart failure or not. 

Data Source: https://www.kaggle.com/andrewmvd/heart-failure-clinical-data


#### Cleaning
```{r}
heart <- read.csv('heart_Eva.csv')
#This data set is nearly perfect, there are no NA's or weird characters.
heart$DEATH_EVENT <- as.factor(heart$DEATH_EVENT)

```

#### Metrics {.tabset}
##### Accuracy
```{r}
set.seed(2702)# setting the seed for replication purposes

split_index <- createDataPartition(heart$DEATH_EVENT, p = .8, #80-20: train-test
                                  list = FALSE,# no lists please
                                  times = 1)#just 1 partition
train_data <- heart[split_index,]

test<- heart[-split_index,]

#creating the decision tree
heart_tree <- train(DEATH_EVENT~., #model formula everything used to classify outcome
                   data=train_data, #use the training data
                   method='rpart',# indicates the use of tree based model
                   na.action = na.omit)#omitting the missing values
                   
heart_tree

xx <- tibble(heart_tree$resample)
heart_tree$finalModel$variable.importance

#And now just for fun! A barplot of the level of importance each variable plays
library(RColorBrewer)
coul <- brewer.pal(5, "Set2")
barplot(heart_tree$finalModel$variable.importance, col=coul)

```

##### Confusion Matrix
```{r}
heart_eval <-(predict(heart_tree,newdata = test))#generates 1s and 0s

heart_eval_prob <- predict(heart_tree,newdata = test, type = "prob")#this gives us the predicted prob, we will need these later for the fairness evaluation


confusionMatrix(heart_eval, test$DEATH_EVENT, positive = "1", dnn=c("Prediction", "Actual"), mode = "sens_spec")


#looking at the error of the confusion matrix
heart_eval_prob$test <- test$DEATH_EVENT

(error = mean(heart_eval != test$DEATH_EVENT))

```

##### ROCR
```{r}
heart_eval <- data.frame(pred_class=heart_eval, pred_prob=heart_eval_prob$`1`,target=as.numeric(test$DEATH_EVENT))

pred <- prediction(heart_eval$pred_prob,heart_eval$target)

tree_perf <- performance(pred,"tpr","fpr")

plot(tree_perf, colorize=TRUE)
abline(a=0, b= 1)

tree_perf_AUC <- performance(pred,"auc")

print(tree_perf_AUC@y.values)

```
##### Other Metrics
```{r}
LogLoss(as.numeric(heart_eval$pred_prob), as.numeric(test$DEATH_EVENT))

F1_Score(as.numeric(heart_eval$pred_class),as.numeric(test$DEATH_EVENT))

```

### Part 2

#### Confusion Matrix Thoughts

From the confusion matrix we can see our True Positive Rate or sensitivity is at 63%, False Positive Rate (1-Specificity) is at 8%, and we want this to be low.
The accuracy is at 83.05%. And the error is at 16.95%

#### Variable Importance
Based off of this evaluation, variable importance, time is the most important variable in determining if a person will have a heart failure. This does make sense as more time you had a heart attack would lead to increased chance of heart failure. 
                          

### Part 3

#### Threshold Adjustment {.tabset}
##### First Set
These are all the same
```{r}
adjust_thres <- function(x, y, z) {
  thres <- as.factor(ifelse(x > y, 1,0))
  confusionMatrix(thres, z, positive = "1", dnn=c("Prediction", "Actual"), mode = "everything")
}

adjust_thres(heart_eval_prob$`1`,.01, test$DEATH_EVENT)
adjust_thres(heart_eval_prob$`1`,.10, test$DEATH_EVENT)
```
##### Second Set
These are all the same
```{r}
adjust_thres(heart_eval_prob$`1`,.50, test$DEATH_EVENT)
adjust_thres(heart_eval_prob$`1`,.75, test$DEATH_EVENT)
adjust_thres(heart_eval_prob$`1`,.80, test$DEATH_EVENT)
```
##### Third Set
```{r}
adjust_thres(heart_eval_prob$`1`,1, test$DEATH_EVENT)
```

##### Deductions



### Part 4 



